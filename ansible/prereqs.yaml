- name: Wait for machines to start
  hosts: all
  gather_facts: no
  tasks:
    - name: Wait for machines to start
      wait_for_connection:
- name: Setup Docker
  hosts: all
  tasks:
    - name: Set /etc/hostname
      become: yes
      lineinfile:
        regex: ".*"
        dest: /etc/hostname
        line: "{{ansible_host}}"
    - name: Set hostname
      become: yes
      hostname:
        name: "{{ansible_host}}"
    - name: upgrade all packages
      become: yes
      yum:
        name: '*'
        state: latest
    - name: remove old docker
      become: yes
      yum:
        name:
          - docker
          - docker-client
          - docker-common
          - docker-latest
          - docker-latest-logrotate
          - docker-logrotate
          - docker-engine
        state: absent
    - name: Install required packages
      become: yes
      yum:
        name:
          # - yum-utils
          - device-mapper-persistent-data
          - lvm2
        state: present
    - name: Add Docker repo
      become: yes
      get_url:
        url: https://download.docker.com/linux/centos/docker-ce.repo
        dest: /etc/yum.repos.d/docker-ce.repo
        force: yes
    - name: Install Docker
      become: yes
      yum:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
        state: present
    - name: Deletes daemon.json
      become: yes
      file:
        path: /etc/docker/daemon.json
        state: absent
    - name: Writes daemon.json
      become: yes
      blockinfile:
        path: /etc/docker/daemon.json
        create: yes
        marker: ""
        block: |
          {
              "exec-opts": [
                  "native.cgroupdriver=systemd"
              ],
              "log-driver": "json-file",
              "log-opts": {
                  "max-size": "100m"
              },
              "storage-driver": "overlay2",
              "storage-opts": [
                  "overlay2.override_kernel_check=true"
              ]
          }
    - name: Create directory
      become: yes
      file:
        path: /etc/systemd/system/docker.service.d
        state: directory
    - name: Start Docker
      become: yes
      systemd:
        name: docker
        state: restarted
        enabled: yes
        daemon_reload: yes
    - name: Create docker group
      become: yes
      group:
        name: docker
        state: present
    - name: Add centos user to docker group
      become: yes
      user:
        name: "{{ansible_user}}"
        group: docker
