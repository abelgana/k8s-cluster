- name: Setup Kubernetes
  hosts: all
  tasks:
    - name: Add Kubernetes repo
      become: yes
      yum_repository:
        name: kubernetes
        description: kubernetes
        baseurl: https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
        enabled: yes
        gpgcheck: yes
        repo_gpgcheck: yes
        gpgkey:
          - https://packages.cloud.google.com/yum/doc/yum-key.gpg
          - https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
        exclude: kube*
    - name: Turn off SELinux
      become: yes
      selinux:
        state: disabled
    - name: Install Kubernetes packages
      become: yes
      yum:
        name:
          - kubelet
          - kubeadm
          - kubectl
        disable_excludes: kubernetes
    - name: Start Kubernetes
      become: yes
      systemd:
        name: kubelet
        state: started
        enabled: yes
    - name: Set sysctl for ipv4
      become: yes
      sysctl:
        name: net.bridge.bridge-nf-call-iptables
        value: 1
        state: present
    - name: Set sysctl for ipv6
      become: yes
      sysctl:
        name: net.bridge.bridge-nf-call-ip6tables
        value: 1
        state: present
    - name: Load module br_netfilter
      become: yes
      modprobe:
        name: br_netfilter
        state: present
- name: Setup Kubernetes Master
  hosts: master
  tasks:
    - name: Run Kubeadm
      become: yes
      shell: kubeadm init --pod-network-cidr=192.168.0.0/16 --apiserver-cert-extra-sans={{ansible_host}},master.k8s.aws.pipsquack.ca
      args:
        creates: /etc/kubernetes/admin.conf
    - name: Udpate config file server
      become: yes
      lineinfile:
        path: /etc/kubernetes/admin.conf
        regexp: '^( *)server: (https?://).*(:\d+)'
        backrefs: yes
        line: '\1server: \2{{ansible_host}}\3'
    - name: Creates directory
      file:
        path: "{{ansible_facts.env.HOME}}/.kube"
        state: directory
    - name: Copy kubeconfig to master .kube
      become: yes
      copy:
        src: /etc/kubernetes/admin.conf
        dest: "{{ansible_facts.env.HOME}}/.kube/config"
        remote_src: yes
        owner: "{{ansible_user}}"
    - name: Copy kubeconfig to ansible host .kube
      become: yes
      fetch:
        src: /etc/kubernetes/admin.conf
        dest: ~/.kube/config
        flat: yes
    - name: Install Calico - RBAC
      shell: kubectl apply -f https://docs.projectcalico.org/v3.3/getting-started/kubernetes/installation/hosted/rbac-kdd.yaml
    - name: Install Calico - Deployment
      shell: kubectl apply -f https://docs.projectcalico.org/v3.3/getting-started/kubernetes/installation/hosted/kubernetes-datastore/calico-networking/1.7/calico.yaml
    - name: Get Kubernets join cluster command
      shell: kubeadm token create --print-join-command
      register: join_cmd

- name: Deploy workers
  hosts: workers
  become: yes
  tasks:
    - name: Run Kubeadm
      shell: "{{hostvars['master'].join_cmd.stdout}}"

- name: Setup Kubernetes dashboard
  hosts: master
  tasks:
    - name: Install Dashboard
      # shell: kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yaml
      shell: kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/master/aio/deploy/recommended/kubernetes-dashboard.yaml

- name: Open Read Only port
  hosts: all
  tasks:
    - name: Udpate config file server
      become: yes
      lineinfile:
        path: /etc/sysconfig/kubelet
        regexp: '^(KUBELET_EXTRA_ARGS=.*)'
        backrefs: yes
        line: '\1 --read-only-port=10255'
    - name: Restart Kubelets
      become: yes
      systemd:
        name: kubelet
        state: restarted
        enabled: yes
        daemon_reload: yes
